@model List<RegistrosReciclaje>

@{
    ViewData["Title"] = "Empresa";
}
<link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="~/css/EstilosEmpresaR/styleInicio.css" asp-append-version="true" />
<link rel="stylesheet" href="~/Web_Recocycle.styles.css" asp-append-version="true" />

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="screen">
</div>

<div class="container-welcome">
    <div class="header">
        <img src="~/imagenes/logo.png" alt="Logo" class="logo" />
        <div class="title">
            <h1>BUSQUEDA RECICLAJE</h1>
            <hr />
        </div>
    </div>
    <center><div class="card-contenedor">
        <div class="Map-Option">

            <div class="Options">
                
                <a asp-action="HistorialRecolecta" asp-controller="Empresa" class="btnHistorial">Historial de Recolecta</a>

                <select id="categoria" name="Categoria" >
                    <option value="" selected disabled hidden>Selecciona una Categoría...</option>
                    <option value="2">Plástico</option>
                    <option value="4">Papel</option>
                    <option value="3">Vídrio</option>
                    <option value="1">Orgánico</option>
                    <option value="5">Metal</option>
                    <option value="6">Batería</option>
                    <option value="7">Otros</option>
                </select>

                <a asp-action="InicioSesionUsuario" asp-controller="Home" class="btnC">CERRAR SESIÓN</a>
            </div>

            <div class="maps">
                <div id="map"></div>
            </div>
        </div>

            @*Script mapa y marcadores*@
            <script>
                const idRecolector = parseInt('@SesionGlobal.IdUsuario');

                var map = L.map('map').setView([-17.3895, -66.1568], 13);
                var markerGroup = L.layerGroup().addTo(map);
                var todosLosRegistros = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);


                function showImageInLargeModal(imagePath) {
                    Swal.fire({
                        imageUrl: imagePath,
                        imageWidth: 'auto',
                        imageHeight: 'auto',
                        imageAlt: 'Imagen de Reciclaje en Grande',
                        showConfirmButton: false,
                        backdrop: `rgba(0,0,0,0.8)`
                    });
                }

                function formatFranjas(horasParaFecha) {
                    return horasParaFecha.map(f => `${f.DesdeHora} a ${f.HastaHora}`).join(' o ');
                }


                function openAsignacionModal(idRegistro, idReciclador, encodedFechas) {

                    const fechasDisponibles = JSON.parse(atob(encodedFechas));

                    var fechasOptions = '<option value="" selected disabled>Selecciona la Fecha</option>';
                    var fechasUnicas = [...new Set(fechasDisponibles.map(f => f.Fecha))];

                    fechasUnicas.forEach(fecha => {
                        fechasOptions += `<option value="${fecha}">${fecha}</option>`;
                    });

                    const style = document.createElement('style');

                    style.innerHTML = `
                        .popup {
                            background: linear-gradient(#064d1a, black);
                            border-radius: 15px;
                            color: white !important;
                            position: relative;
                            overflow: hidden;
                        }

                    `;

                    var htmlContent = `
                            <p style="text-align: left; color: white;">Selecciona la **fecha** y la **franja horaria de recolección**:</p>
                            <div style="text-align: left; margin-bottom: 15px;">
                                <label for="swal-fecha">Fecha:</label>
                                <select id="swal-fecha" class="swal2-input" style="width: 90%;" required>
                                    ${fechasOptions}
                                </select>
                            </div>
                            <div style="text-align: left; display: flex; gap: 10px;">
                                <div style="flex: 1;">
                                    <label for="swal-desdehora">Desde Hora:</label>
                                    <input type="time" id="swal-desdehora" class="swal2-input" style="width: 80%; background-color: white; color: black;" value="" required>
                                </div>
                                <div style="flex: 1;">
                                    <label for="swal-hastahora">Hasta Hora:</label>
                                    <input type="time" id="swal-hastahora" class="swal2-input" style="width: 80%; background-color: white; color: black;" value="" required>
                                </div>
                            </div>
                    `;
                    document.head.appendChild(style);
                    Swal.fire({
                        title: 'Asignar Recolección',
                        html: htmlContent,
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Confirmar Asignación',
                        cancelButtonText: 'Cancelar',
                        customClass: {
                            popup: 'popup',
                        },
                        preConfirm: () => {
                            const fechaSeleccionada = document.getElementById('swal-fecha').value;
                            const desdeHora = document.getElementById('swal-desdehora').value;
                            const hastaHora = document.getElementById('swal-hastahora').value;

                            if (!fechaSeleccionada || !desdeHora || !hastaHora) {
                                Swal.showValidationMessage('Debes seleccionar una fecha y especificar las horas.');
                                return false;
                            }

                            if (hastaHora <= desdeHora) {
                                Swal.showValidationMessage('La "Hasta Hora" debe ser posterior a la "Desde Hora".');
                                return false;
                            }


                            const horasParaFecha = fechasDisponibles.filter(f => f.Fecha === fechaSeleccionada);
                            let esValido = false;

                            if (horasParaFecha.length === 0) {
                                Swal.showValidationMessage('No hay franjas horarias disponibles para la fecha seleccionada.');
                                return false;
                            }

                            for (const franja of horasParaFecha) {
                                if (desdeHora >= franja.DesdeHora && hastaHora <= franja.HastaHora) {
                                    esValido = true;
                                    break; 
                                }
                            }

                            if (!esValido) {
                                const franjasDisponiblesStr = formatFranjas(horasParaFecha);
                                Swal.showValidationMessage(`las horas seleccionadas (${desdeHora} a ${hastaHora}) no se encuentra dentro del rango disponibles: ${franjasDisponiblesStr}.`);
                                return false;
                            }
                            return {
                                fecha: fechaSeleccionada,
                                desdeHora: desdeHora,
                                hastaHora: hastaHora
                            };
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            asignarRecoleccion(idRegistro, idReciclador, result.value.fecha, result.value.desdeHora, result.value.hastaHora);
                        }
                    });
                }

                function asignarRecoleccion(idRegistroReciclaje, idReciclador, fecha, desdeHora, hastaHora) {

                    if (isNaN(idRecolector) || idRecolector <= 0) {
                        Swal.fire('Error de Sesión', 'No se pudo identificar al Recolector logueado.', 'error');
                        return;
                    }

                    fetch('/Empresa/AsignarRecoleccion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            idRegistroReciclaje: idRegistroReciclaje,
                            idRecolector: idRecolector,
                            idReciclador: idReciclador,
                            fecha: fecha,
                            desdeHora: desdeHora,
                            hastaHora: hastaHora
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            Swal.fire('¡Asignación Exitosa!', data.message, 'success')
                               .then(() => {
                                   location.reload();
                               });
                        } else {
                            Swal.fire('Error de Asignación', data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error de Comunicación', `No se pudo completar la transacción. Detalle: ${error.message}`, 'error');
                    });
                }


                function dibujarMarcadores(registrosAFiltrar) {

                    markerGroup.clearLayers();

                    registrosAFiltrar.forEach(function (registro) {
                        if (registro.Latitud && registro.Longitud) {
                            var lat = parseFloat(registro.Latitud);
                            var lng = parseFloat(registro.Longitud);

                            var imagesHtml = '';
                            if (registro.Imagenes && registro.Imagenes.length > 0) {
                                imagesHtml += `<div class="popup-gallery-container" style="display: flex; overflow-x: auto; margin-bottom: 10px; padding: 5px;">`;

                                registro.Imagenes.forEach(function(imagen) {
                                    var imagePath = imagen.Imagenes;
                                    if (imagePath && !imagePath.startsWith('data:')) {
                                        imagePath = `data:image/jpeg;base64,${imagePath}`;
                                    }

                                    imagesHtml += `
                                        <img src="${imagePath}"
                                             alt="Reciclaje"
                                             style="width: 50px; height: 50px; object-fit: cover; margin-right: 5px; border-radius: 4px; flex-shrink: 0; cursor: pointer;"
                                             onclick="showImageInLargeModal('${imagePath}')" />
                                    `;
                                });

                                imagesHtml += `</div>`;
                            }

                            var fechasHtml = '<ul>';
                            if (registro.FechasDisponibles && registro.FechasDisponibles.length > 0) {
                                registro.FechasDisponibles.forEach(function(fecha) {
                                    fechasHtml += `<li style="color: #ddd;">${fecha.Fecha} (${fecha.DesdeHora} - ${fecha.HastaHora})</li>`;
                                });
                            } else {
                                fechasHtml += '<li style="color: #ddd;">No hay fechas disponibles registradas.</li>';
                            }
                            fechasHtml += '</ul>';

                            var registroJSON = JSON.stringify(registro.FechasDisponibles);
                            var encodedFechas = btoa(registroJSON);


                            var popupContent = `
                                <div style="background: linear-gradient(180deg, #1e4620 0%, #000000 100%); color: white; padding: 10px; border-radius: 8px;">
                                    <div class="popup-images">${imagesHtml}</div>

                                    <div class="popup-data" style="margin-bottom: 10px;">
                                        <hr style="border-color: #333;" />
                                        <b>Categoría:</b> ${registro.NombreCategoria}<br>
                                        <b>Descripción:</b> ${registro.Descripcion || 'N/A'}<br>
                                        <b>Publicado por:</b> ${registro.NombreCompletoReciclador}<br>
                                        <b>Publicado el:</b> ${new Date(registro.FechaRegistro).toLocaleDateString()}
                                        <hr style="border-color: #333;" />
                                    </div>

                                    <div class="popup-fechas">
                                        <b>Horarios Disponibles:</b>
                                        ${fechasHtml}
                                        <hr style="border-color: #333;" />
                                    </div>

                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                        <button type="button" class="btn-confirmar" style="background: Green; color : white; border-radius: 10px;"
                                            onclick="openAsignacionModal(
                                                ${registro.IdRegistroReciclaje},
                                                ${registro.IdUsuario},
                                                '${encodedFechas}'
                                            )">
                                            SELECCIONAR
                                        </button>
                                    </div>
                                </div>
                            `; 

                            L.marker([lat, lng])
                                .addTo(markerGroup)
                                .bindPopup(popupContent, { minWidth: 350, maxHeight: 400 });
                        }
                    });
                }


                document.getElementById('categoria').addEventListener('change', function() {
                    var idCategoriaSeleccionada = parseInt(this.value);
                    var registrosFiltrados;

                    console.log("Categoría Seleccionada (ID):", idCategoriaSeleccionada);
                    console.log("Total Registros:", todosLosRegistros.length);


                    if (isNaN(idCategoriaSeleccionada) || idCategoriaSeleccionada === 0) {
                        registrosFiltrados = todosLosRegistros;
                    } else {
                        registrosFiltrados = todosLosRegistros.filter(function(registro) {
                            var registroId = parseInt(registro.Categoria);
                            return registroId === idCategoriaSeleccionada;
                        });
                    }

                    console.log("Registros Filtrados:", registrosFiltrados.length);

                    dibujarMarcadores(registrosFiltrados);
                });

                dibujarMarcadores(todosLosRegistros);

            </script>
    </div></center>
</div>